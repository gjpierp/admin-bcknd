<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Backend - Demo Auth</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        background: #f7f7f8;
        color: #1f2328;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #0d1117;
        color: #fff;
      }
      .brand {
        font-weight: 600;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #30363d;
        background: #1f6feb;
        color: white;
        cursor: pointer;
      }
      button.secondary {
        background: #0d1117;
        color: #c9d1d9;
        border-color: #30363d;
      }
      main {
        max-width: 900px;
        margin: 24px auto;
        background: white;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        padding: 16px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .card {
        border: 1px solid #d0d7de;
        border-radius: 8px;
        padding: 12px;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
      }
      .muted {
        color: #57606a;
        font-size: 12px;
      }
      .status {
        margin-top: 8px;
      }
      pre {
        background: #f6f8fa;
        padding: 8px;
        border-radius: 6px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">Admin Backend</div>
      <div class="actions">
        <button id="btn-login">Iniciar sesión</button>
        <button id="btn-register" class="secondary">Registrarse</button>
        <button id="btn-renew" class="secondary" style="display: none">
          Renovar token
        </button>
        <button id="btn-logout" class="secondary" style="display: none">
          Cerrar sesión
        </button>
      </div>
    </header>

    <main>
      <div class="row">
        <div class="card">
          <h3>Estado de sesión</h3>
          <div id="estado" class="status">No autenticado</div>
          <div class="muted">
            El token se guarda en localStorage como <strong>token</strong>.
          </div>
        </div>
        <div class="card">
          <h3>Formulario de acceso</h3>
          <form id="form-login">
            <label>Correo electrónico</label>
            <input
              id="email"
              type="email"
              placeholder="correo@ejemplo.com"
              required
            />
            <label style="margin-top: 8px; display: block">Contraseña</label>
            <input
              id="password"
              type="password"
              placeholder="******"
              required
            />
            <div style="margin-top: 12px; display: flex; gap: 8px">
              <button type="submit">Entrar</button>
              <button type="button" id="cancel-login" class="secondary">
                Cancelar
              </button>
            </div>
          </form>
          <div id="login-msg" class="muted" style="margin-top: 8px"></div>
        </div>
        <div class="card">
          <h3>Formulario de registro</h3>
          <form id="form-register" style="display: none">
            <label>Nombre de usuario</label>
            <input
              id="reg-nombre-usuario"
              type="text"
              placeholder="nombre_usuario"
              minlength="3"
              maxlength="50"
              required
            />
            <label style="margin-top: 8px; display: block">Nombres</label>
            <input
              id="reg-nombres"
              type="text"
              placeholder="Nombres"
              minlength="2"
              maxlength="100"
              required
            />
            <label style="margin-top: 8px; display: block">Apellidos</label>
            <input
              id="reg-apellidos"
              type="text"
              placeholder="Apellidos"
              minlength="2"
              maxlength="100"
              required
            />
            <label style="margin-top: 8px; display: block"
              >Correo electrónico</label
            >
            <input
              id="reg-email"
              type="email"
              placeholder="correo@ejemplo.com"
              required
            />
            <label style="margin-top: 8px; display: block">Contraseña</label>
            <input
              id="reg-password"
              type="password"
              placeholder="******"
              minlength="6"
              required
            />
            <div style="margin-top: 12px; display: flex; gap: 8px">
              <button type="submit">Crear cuenta</button>
              <button type="button" id="cancel-register" class="secondary">
                Cancelar
              </button>
            </div>
          </form>
          <div id="register-msg" class="muted" style="margin-top: 8px"></div>
        </div>
      </div>

      <div class="card" style="margin-top: 16px">
        <h3>Respuesta última operación</h3>
        <pre id="output">(sin datos)</pre>
      </div>
      <div class="card" style="margin-top: 16px">
        <h3>Menú del usuario</h3>
        <div id="menu-tree" class="muted">(sin menú)</div>
      </div>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);

      function getToken() {
        return localStorage.getItem("token");
      }

      function setToken(token) {
        if (token) localStorage.setItem("token", token);
        else localStorage.removeItem("token");
        renderState();
      }

      function renderState() {
        const token = getToken();
        const auth = !!token;
        $("estado").textContent = auth ? "Autenticado" : "No autenticado";
        $("btn-login").style.display = auth ? "none" : "inline-block";
        $("btn-register").style.display = auth ? "none" : "inline-block";
        $("btn-logout").style.display = auth ? "inline-block" : "none";
        $("btn-renew").style.display = auth ? "inline-block" : "none";
        $("form-login").style.display = auth ? "none" : "block";
        $("form-register").style.display = "none";
        const menuTree = $("menu-tree");
        if (menuTree && !auth) menuTree.textContent = "(sin menú)";
      }

      async function doLogin(email, password) {
        try {
          const resp = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              correo_electronico: email,
              contrasena: password,
            }),
          });
          const data = await resp.json();
          $("output").textContent = JSON.stringify(data, null, 2);
          if (data.ok && data.token) {
            setToken(data.token);
            $("login-msg").textContent = data.msg || "Inicio de sesión exitoso";
            if (Array.isArray(data.menu)) {
              renderMenu(data.menu);
            } else {
              $("menu-tree").textContent = "(sin menú)";
            }
          } else {
            setToken(null);
            $("login-msg").textContent = data.msg || "Error de autenticación";
            $("menu-tree").textContent = "(sin menú)";
          }
        } catch (e) {
          $("output").textContent = e.message;
          setToken(null);
          $("login-msg").textContent = "Error en el servidor";
          $("menu-tree").textContent = "(sin menú)";
        }
      }

      async function doRenew() {
        const token = getToken();
        if (!token) return;
        try {
          const resp = await fetch("/api/login/renew", {
            method: "GET",
            headers: { "x-token": token },
          });
          const data = await resp.json();
          $("output").textContent = JSON.stringify(data, null, 2);
          if (data.ok && data.token) {
            setToken(data.token);
          }
        } catch (e) {
          $("output").textContent = e.message;
        }
      }

      function doLogout() {
        setToken(null);
        $("output").textContent = "(sesión cerrada)";
        $("login-msg").textContent = "";
        $("menu-tree").textContent = "(sin menú)";
      }

      // Eventos UI
      $("btn-login").addEventListener("click", () => {
        $("form-login").style.display = "block";
        $("email").focus();
        $("form-register").style.display = "none";
        $("register-msg").textContent = "";
      });
      $("btn-register").addEventListener("click", () => {
        $("form-register").style.display = "block";
        $("reg-nombre-usuario").focus();
        $("form-login").style.display = "none";
        $("login-msg").textContent = "";
      });
      $("cancel-login").addEventListener("click", () => {
        $("form-login").reset();
        $("form-login").style.display = "none";
        $("login-msg").textContent = "";
      });
      $("cancel-register").addEventListener("click", () => {
        $("form-register").reset();
        $("form-register").style.display = "none";
        $("register-msg").textContent = "";
      });
      $("form-login").addEventListener("submit", (e) => {
        e.preventDefault();
        const email = $("email").value.trim();
        const password = $("password").value;
        doLogin(email, password);
      });
      $("form-register").addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
          nombre_usuario: $("reg-nombre-usuario").value.trim(),
          nombres: $("reg-nombres").value.trim(),
          apellidos: $("reg-apellidos").value.trim(),
          correo_electronico: $("reg-email").value.trim(),
          contrasena: $("reg-password").value,
        };
        try {
          const resp = await fetch("/api/usuarios", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          $("output").textContent = JSON.stringify(data, null, 2);
          if (data.ok && data.token) {
            setToken(data.token);
            $("register-msg").textContent = data.msg || "Registro exitoso";
            if (Array.isArray(data.menu)) {
              renderMenu(data.menu);
            } else {
              $("menu-tree").textContent = "(sin menú)";
            }
          } else {
            $("register-msg").textContent = data.msg || "Error al registrar";
            $("menu-tree").textContent = "(sin menú)";
          }
        } catch (e) {
          $("output").textContent = e.message;
          $("register-msg").textContent = "Error en el servidor";
          $("menu-tree").textContent = "(sin menú)";
        }
      });

      // Renderizado del árbol de menú del usuario
      function renderMenu(menu) {
        const container = document.getElementById("menu-tree");
        if (!Array.isArray(menu) || menu.length === 0) {
          container.textContent = "(sin menú)";
          return;
        }
        container.innerHTML = "";
        container.appendChild(buildList(menu));
      }

      function buildList(items) {
        const ul = document.createElement("ul");
        ul.style.listStyle = "disc";
        ul.style.paddingLeft = "20px";
        items.forEach((item) => {
          const li = document.createElement("li");
          const title = document.createElement("span");
          title.textContent = item.titulo || "(sin título)";
          li.appendChild(title);
          if (item.url) {
            const link = document.createElement("a");
            link.href = `#${item.url}`;
            link.textContent = ` (${item.url})`;
            link.style.color = "#0969da";
            link.style.textDecoration = "none";
            li.appendChild(link);
          }
          if (Array.isArray(item.submenu) && item.submenu.length) {
            li.appendChild(buildList(item.submenu));
          }
          ul.appendChild(li);
        });
        return ul;
      }
      $("btn-renew").addEventListener("click", doRenew);
      $("btn-logout").addEventListener("click", doLogout);

      // Render inicial
      renderState();
    </script>
  </body>
</html>
